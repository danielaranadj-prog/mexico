---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { getToursByCountry } from '../lib/fetchTours';

// Fetch tours desde Firestore (con fallback a hardcoded)
const toursData = await getToursByCountry('mexico');

// Transformar al formato esperado por el template
const allTours = toursData.map((tour, idx) => ({
  id: idx + 1,
  ciudad: tour.ciudad,
  titulo: tour.titulo,
  precio: tour.precio,
  duracion: tour.duracion,
  imagen: tour.imagen,
  link: tour.linkAfiliado || '#'
}));

// Extraer ciudades únicas para los filtros dinámicos
const uniqueCities = [...new Set(allTours.map(t => t.ciudad))];

const filters = [
  { id: 'all', label: 'Todos' },
  ...uniqueCities.map(city => ({
    id: city,
    label: city.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
  }))
];
---

<Layout title="Tours y Actividades en México | Instante Trips" description="Descubre los mejores tours y experiencias en México.">
  <Navbar />
  
  <main class="page-container">
    <header class="page-header">
      <h1>Explora México</h1>
      <p>Las mejores experiencias seleccionadas para vos.</p>
    </header>

    <div class="filters-wrapper">
      <div class="filters-scroll">
        {filters.map((f, index) => (
          <button 
            class={`filter-btn ${index === 0 ? 'active' : ''}`} 
            data-filter={f.id}
          >
            {f.label}
          </button>
        ))}
      </div>
    </div>

    <div class="tours-grid" id="tours-container">
      {allTours.map((tour) => (
        <a 
          href={tour.link} 
          target="_blank" 
          class="tour-card" 
          data-city={tour.ciudad}
        >
          <div class="card-image" style={`background-image: url('${tour.imagen}')`}>
            <div class="tag-overlay">
              <span class="duration"><i class="far fa-clock"></i> {tour.duracion}</span>
            </div>
          </div>
          <div class="card-content">
            <span class="city-label">{tour.ciudad.replace('-', ' ')}</span>
            <h3>{tour.titulo}</h3>
            <div class="card-bottom">
              <span class="price">{tour.precio}</span>
              <span class="btn-arrow"><i class="fas fa-chevron-right"></i></span>
            </div>
          </div>
        </a>
      ))}
    </div>

    <div id="no-results" class="hidden">
      <p>No hay actividades disponibles en esta categoría por el momento.</p>
    </div>

  </main>
</Layout>

<script>
  // LÓGICA DE FILTRADO
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.tour-card');
    
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        // 1. Manejo visual de botones (Active state)
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 2. Obtener filtro
        const filterValue = btn.getAttribute('data-filter');

        // 3. Filtrar tarjetas con animación
        cards.forEach(card => {
          const cardCity = card.getAttribute('data-city');
          const htmlCard = card as HTMLElement;
          
          if (filterValue === 'all' || filterValue === cardCity) {
            htmlCard.style.display = 'flex';
            // Pequeño timeout para permitir transición de opacidad si quisieras animar
            setTimeout(() => htmlCard.style.opacity = '1', 50);
          } else {
            htmlCard.style.display = 'none';
            htmlCard.style.opacity = '0';
          }
        });
      });
    });
  });
</script>

<style>
  .page-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 100px 20px 60px 20px; /* Padding top para el navbar fijo */
    min-height: 100vh;
  }

  .page-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .page-header h1 {
    font-size: 2.2rem;
    margin-bottom: 10px;
  }

  .page-header p {
    color: var(--text-secondary);
    font-size: 1rem;
  }

  /* --- FILTROS ESTILO iOS --- */
  .filters-wrapper {
    position: sticky;
    top: 70px; /* Debajo del navbar */
    z-index: 90;
    background: var(--bg); /* Se funde con el fondo */
    padding: 10px 0;
    margin-bottom: 30px;
    /* Máscara de degradado para indicar scroll */
    mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
    -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
  }

  .filters-scroll {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 5px 20px;
    justify-content: flex-start; /* Alineado a la izquierda en móvil */
    scrollbar-width: none;
  }
  
  .filters-scroll::-webkit-scrollbar { display: none; }

  /* Centrar filtros en desktop si caben */
  @media (min-width: 768px) {
    .filters-scroll { justify-content: center; }
  }

  .filter-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    font-family: 'Inter', sans-serif;
  }

  .filter-btn:hover {
    border-color: var(--text);
  }

  .filter-btn.active {
    background: var(--text);
    color: var(--bg); /* Texto inverso */
    border-color: var(--text);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  /* --- GRID DE TOURS --- */
  .tours-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
  }

  .tour-card {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    text-decoration: none;
    border: 1px solid var(--border);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    height: 340px;
  }

  .tour-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }

  .card-image {
    height: 60%;
    background-size: cover;
    background-position: center;
    position: relative;
  }

  .tag-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
  }

  .duration {
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    color: white;
    font-size: 0.7rem;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 500;
  }

  .card-content {
    padding: 15px;
    height: 40%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .city-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--gold);
    font-weight: 700;
    letter-spacing: 1px;
    margin-bottom: 5px;
  }

  .card-content h3 {
    font-size: 1.1rem;
    color: var(--title);
    font-weight: 700;
    margin: 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }

  .price {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--text);
  }

  .btn-arrow {
    width: 30px;
    height: 30px;
    background: var(--bg);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text);
    transition: background 0.2s;
  }
  
  .tour-card:hover .btn-arrow {
    background: var(--gold);
    color: white;
  }

  .hidden { display: none; }
</style>